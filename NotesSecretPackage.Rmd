---
title: "understanding public criptography"
output: html_notebook
---

notes while lookign this [video](http://blog.revolutionanalytics.com/2017/07/secret-package.html) or this [video](https://channel9.msdn.com/Events/useR-international-R-User-conferences/useR-International-R-User-2017-Conference/Can-you-keep-a-secret)

## Summary:

```{r}
# # Exploring the secret package
# install.packages("secret") #does not worked...

# # this worked out!
# devtools::install_github("gaborcsardi/secret")
# # My secret will be located here:

fakepassword <- "MyFakePassword334455"

```


How to keep secrets safe and secure? 
How to collaborate while keeping secretes?

### Objectives I want to reach!

I want to keep some of my data encrypted in *github* project:

- I can use it in my home fxtrams PC...
- I can also use it in my travelling mac book laptop
- The communication from PC and Laptop must be SSH encrypted too

I would like to keep my code open on github develop it freely and at the same time develop text, description and course structure. I want to do that all in R-Studio IDE with advantage to keep Version Control all the time

this brings the key objective to reach: to **ENCRYPT FILE INSIDE MY PROJECT**

Optional: know how to keep files encrypted while having a private key in the USB stick

### Every user has a private / public key pair

-- share public key with open (keep in the R project or github)
-- keep private key on the computer

### Encrypt with:

- private key +
- public key

### Decrypt with: 

- use private key

## About generating private/public keys...

I have already created my *private* key while using gitHub [SSH](https://help.github.com/articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent/)
[About PuttyGen](https://www.ssh.com/ssh/putty/windows/puttygen)

For the sake of this exercise I would generate one more key later but now I will use existing keys...

My Keys are stored in the folder [.ssh](C:\Users\fxtrams\.ssh)

## Using 'secret' package

[package documentation](https://cran.r-project.org/web/packages/secret/secret.pdf)
[vignette](https://cran.r-project.org/web/packages/secret/vignettes/secrets.html)

### get the package

```{r}
# this worked out!
devtools::install_github("gaborcsardi/secret")
library(secret)
library(magrittr)
```

### some trials...

My keys are in the folder...
```{r}
# set up local user
# my private key is ~/.ssh
#dir("~/.ssh")
dir("C:/Users/fxtrams/.ssh")
```

It's then necessary to set up the *system variable*
```{r}
# setting a local private key to the system variable...
Sys.setenv(USER_KEY = "C:/Users/fxtrams/.ssh/id_rsa")
Sys.getenv("USER_KEY")

```

Test that the package can read your key. This might fail if you donâ€™t have a key at ~/.ssh/id_rsa, or if your private key has a pass phrase and R in running in non-interactive mode.

```{r}
# now trying my local key.. passfrase will be required...this function reads my key
local_key()
# just to investigate how the key is built: tempKey <- local_key()
```

Create a VAULT... in my working project directory
```{r}
# getting working directory to the variable original_wd
original_wd <- getwd()
original_wd
# creating a vault named myVault1
dir.create(file.path(original_wd, "myVault1"))
create_vault(file.path(original_wd, "myVault1"))

```
Now I have two vaults:

- myVault -> to be used with a sample keys
- myVault1 -> to be used with my keys

Obviously now this Vault can be actually placed to the github cloud! This is because the vault is containing the two folders:

- secrets - are the files that will be encrypted
- users - are the users that can decrypt using their private key

```{r}
dir("myVault")
dir("myVault1")
```

### Intermediate conclusion

Practically speaking the situation is:

- we have a vault inside the project folder
- we have a private/public key in the computer folder

I can now add users to the Vault for the demo purposes

## Practicing with Demo Keys

### adding users to the vault myVault
```{r}
## Specifying where are the keys!
key_dir <- file.path(system.file(package = "secret"), "user_keys") # this directory contains demo keys
alice_public_key <- file.path(key_dir, "alice.pub") # this variable now contain path to the public key of alice
alice_private_key <- file.path(key_dir, "alice.pem") # this variable now contain path to the private key of alice

## reading public key with openssl package:
openssl::read_pubkey(alice_public_key)

```

### adding public key to the vault
```{r}
# adding public key of the alice user to the vault myVault
add_user("alice", alice_public_key, vault = "myVault")
```
now the user alice private key eventually moved to the myVault/users

```{r}
dir("myVault/users")
```

### now it's time to add secrete using the public key

To start, let's define that object *fakepassword* will be our secret, so we will ecrypt it in the vault

```{r}
# adding a secret to the vault
add_secret("myFirstSecret", fakepassword, users = "alice", vault = "myVault")
```

Amazing! Now in folder *myVault/secret* we have another folder *myFirstSecret* containing our secret!

```{r}
# content of the encrypted object
dir("myVault/secrets/myFirstSecret")
```

Victory! the thing is totally encrypted!

### now let's get back the secret using the private key

It's possible to decrypt a secret with a private key that corresponds to the public key that was used to ecrypt

```{r}
# getting the secret
get_secret("myFirstSecret", key = alice_private_key, vault = "myVault")

```

Amazing! the secret is again decrypted!

## Conclusion

Now it was possible to use private and public key to ecrypt and decrypt secret. 

## Let's repeat the process with my own key...

```{r}
# creating a vault


key_dir1 <- "C:/Users/fxtrams/.ssh"
pub_key_dir <- file.path(key_dir1, "id_rsa.pub") #directory for public key
prv_key_dir <- file.path(key_dir1, "id_rsa")
## reading public key with openssl package:
openssl::read_pubkey(pub_key_dir)
# adding user to the vault myVault1
add_user("vzhomeexperiments", public_key = pub_key_dir, vault = "myVault1")
# add secret to the vault myVault1
add_secret(name = "mySecondSecret", value = fakepassword, users = "vzhomeexperiments", vault = "myVault1")

# get that secret usign the private key
get_secret(name = "mySecondSecret", key = prv_key_dir, vault = "myVault1")

```

